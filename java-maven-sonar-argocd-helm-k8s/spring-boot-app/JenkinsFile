pipeline {
    agent any

    environment {
        DOCKER_IMAGE = "channamma/happyapp:latest"
        GIT_REPO_NAME = "devops"
        GIT_USER_NAME = "channammarani586"
        IMAGE_VERSION = "4"  // Change this as needed
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "üîÑ Checking out repository..."
                    git branch: 'main', url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git"
                }
            }
        }

        stage('Pull Docker Image') {
            steps {
                script {
                    echo "üê≥ Pulling latest Docker image..."
                    sh """
                        if ! docker pull ${DOCKER_IMAGE}; then
                            echo '‚ö†Ô∏è Failed to pull Docker image, proceeding with the build...'
                        fi
                    """
                }
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                script {
                    echo "üì¶ Building and pushing Docker image..."
                    sh """
                        docker build -t ${DOCKER_IMAGE} .
                        docker tag ${DOCKER_IMAGE} ${DOCKER_IMAGE}:${IMAGE_VERSION}
                        docker login -u your-dockerhub-username -p your-dockerhub-password
                        docker push ${DOCKER_IMAGE}
                        docker push ${DOCKER_IMAGE}:${IMAGE_VERSION}
                    """
                }
            }
        }

        stage('Update Deployment File') {
            steps {
                withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                    script {
                        echo "üîß Updating Kubernetes deployment file..."
                        sh """
                            git config --global user.email "sbiradarchannamma@gmail.com"
                            git config --global user.name "${GIT_USER_NAME}"

                            if [ -f java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml ]; then
                                sed -i "s|image: channamma/happyapp:.*|image: ${DOCKER_IMAGE}:${IMAGE_VERSION}|g" java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml
                                git add java-maven-sonar-argocd-helm-k8s/spring-boot-app-manifests/deployment.yml
                            else
                                echo "‚ùå Deployment file not found!"
                                exit 1
                            fi

                            git commit -m "üîÑ Updated deployment image to ${IMAGE_VERSION}"
                            git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME} HEAD:main || echo "‚ö†Ô∏è Git push failed!"
                        """
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "üöÄ Deploying to Kubernetes..."
                    sh """
                        if ! command -v kubectl &> /dev/null; then
                            echo "‚ùå kubectl not found! Please install and configure it."
                            exit 1
                        fi

                        kubectl apply -f /home/nginx-deployment.yaml || echo "‚ö†Ô∏è Deployment failed!"
                        kubectl apply -f /home/nginx-service.yaml || echo "‚ö†Ô∏è Service deployment failed!"
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs() // Clears workspace before the next build
        }
    }
}
